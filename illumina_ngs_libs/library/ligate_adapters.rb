# By: Eriberto Lopez
# elopez3@uw.edu
# Production 10/05/18

module Ligate_Adapters
    include Units
    
    def gather_and_defrost_ligate_adapters_materials(num_ops, op_type, index_plate_type=nil)
        # TODO: Include the index plate and ligation mix
        reagents_hash = {
            "Ligation Control (CTL)" => "1-2 tube(s)", #/48rxns
            "Ligation Mix (LIG)" => "1-2 tube(s)", #/48rxns
            "Resuspension Buffer (RSB)" => "1-2 tube(s)", #/48rxns
            "Stop Ligation Buffer (STL)" => "1-2 tube(s)", #/48rxns
            "AMPure XP Beads" => (op_type == "Adenylate 3' Ends") ? "Bottle" : reagent_vol_with_extra(num_ops, 92),#ul
            "Freshly Prepared 80% Ethanol" => (op_type == "Adenylate 3' Ends") ? "Bottle" : reagent_vol_with_extra(num_ops, 800)#ul
        }
        if op_type.name == "Adenylate 3' Ends"
            show do
                title "Gather and Defrost Materials"
                separator
                note "Gather the following reagents and defrost at room temperature:"
                reagents_hash.each {|k,v| check "#{k}"}
            end
        elsif op_type.name == "Ligate Adapters"
            show do
                title "Gather and Defrost Materials"
                separator
                note "Thaw the following materials at room temperature then immediately place on ice:"
                check "Index/Adapter Plate: <b>#{index_plate_type}</b>"
                check "1-2 tube(s) of Ligation Mix (LIG)"
                note "\n"
                note "Gather the following materials:"
                check "<b>7</b> - Adhesive Seal(s)"
                check "<b>1</b> - 96 Well PCR Plate"
                check "<b>1</b> - 96 Well MIDI 0.8mL Plate"
            end
        end
    end
    
    def add_ligation_mix(collection)
        
        ctl_tot_vol = (collection.get_non_empty.length).round()*2.5
        ctl_vol = ctl_tot_vol/100
        ctl_h2o_vol = ctl_tot_vol - ctl_vol
        if collection.get_non_empty.length > 19
            sw, sw_vol_mat, rc_list = multichannel_vol_stripwell(collection)
            show do
                title "Preparing Ligation Master Mix"
                separator
                check "Spin down the Ligation Control (CTL) & Stop Ligation Buffer (STL)."
                check "Create #{ctl_tot_vol}#{MICROLITERS} of 1:100 CTL => #{ctl_h2o_vol}#{MICROLITERS} MG H2O + #{ctl_vol}#{MICROLITERS} CTL"
                note "Follow the table to aliquot the Ligation Control (CTL) into a stripwell for the next step:"
                table highlight_alpha_rc(sw, rc_list){|r,c| "#{sw_vol_mat[r][c]*2.5}#{MICROLITERS}"}
            end
            sw.mark_as_deleted
            sw.save
        else
            show do
                title "Preparing Ligation Master Mix"
                separator
                check "Spin down the Ligation Control (CTL) & Stop Ligation Buffer (STL)."
                check "Create #{ctl_tot_vol}#{MICROLITERS} of 1:100 CTL => #{ctl_h2o_vol}#{MICROLITERS} MG H2O + #{ctl_vol}#{MICROLITERS} CTL"
            end
        end
            
        show do
            title "Adding Ligation Mix to #{collection.id}"
            separator
            note "Follow the table below to aliquot the <b>Ligation Mix</b> to the appropriate wells:"
            bullet "Thoroughly mix by pipetting 5 times"
            table highlight_alpha_non_empty(collection){|r,c| "#{5}#{MICROLITERS}"}
        end
    end
    
    def add_adapters_from_adapter_plate(in_collection, out_collection, adapter_plate_type)
        # Uses the IlluminaAdapterPlateLib/FindUpdateIlluminaAdapterPlate module        
        available_adapter_plates = find_illumina_adapter_plates(adapter_plate_type)
        # log_info 'available_adapter_plates', available_adapter_plates
        adapter_plate_hash = create_adapters_in_adapter_plate_hash(available_adapter_plates)
        # Indexes should be associated to the new output collection generated by this protocol
        associating_and_updating_adapter_plate(adapter_plate_hash, out_collection)
        
        # Show which adapters go to which wells by using sample_name alpha numeric coordinate
        experimental_collection_ngs_mat = Item.find(out_collection.id).get('ngs_tracking_matrix')
        exp_coll_ngs_mat_adapter_name = experimental_collection_ngs_mat.map {|row|
            row.map {|obj|
                if obj != -1
                    (!obj[:sample_name].nil?) ? (obj[:sample_name].split('_')[-1]) : -1
                end
            }
        }
        
        sample_type = in_collection.matrix.flatten.select {|s_id| s_id != -1}.map {|s_id| Sample.find(s_id).sample_type.name }.uniq
        library_type = (sample_type == "Yeast Strain") ? "cDNA" : "DNA"
        
        take(available_adapter_plates, interactive: true)
        
        show do 
            title "Adding Adapters/Indexes to Plate #{in_collection}"
            separator
            check "Gather the Adapter Plate: <b>#{adapter_plate_type}</b>"
            check "Check to see that the plate has defrosted"
            check "Next, centrifuge plate at 280 x g for 30 secs"
        end
        show do 
            title "Adding Adapters/Indexes to Plate #{in_collection}"
            separator
            warning "WHEN USING THE ADAPTER PLATE MAKE SURE THAT IT IS IN THE CORRECT ORIENTATION!"
            note "If you will be using unopened wells, clean the seal with 70% EtOH then pierce with a clean stripwell."
            note "\n"
            note "Follow the table below to aliquot <b>2.5#{MICROLITERS}</b> the correct Index/Adapter to the appropriate wells of <b>#{in_collection}</b>:"
            bullet "The alpha numeric coordinates coorespond to the well in the <b>#{adapter_plate_type}</b>"
            bullet "Thoroughly mix by pipetting 7 times"
            table highlight_alpha_non_empty(in_collection){|r,c| "Idx_#{exp_coll_ngs_mat_adapter_name[r][c]}"}
            check "Finally, seal plate with clear adhesive seal & centrifuge plate at 280 x g for 1 min."
        end
    end
    
    def incubate_adapter_ligation_plate(collection)
        show do
            title "Incubating Adapter Ligation Plate #{collection}"
            separator
            check "Place sealed plate on a thermocycler, close lid, and select: <b>Ligate_Index</b>"
            note "Thermocycler Conditions:"
            bullet "Pre-heat lit to 100°C"
            bullet "30°C for 10 mins"
            bullet "Hold at 4°C" # Give plate 4°C for 1 min (similar to being on ice for 1 min)
            check "Set a timer for 10 mins"
            note "Continue on to the next step while incubating plate."
        end
    end
    
    def add_stop_ligation_buffer(collection)
        if collection.get_non_empty.length > 19
            sw, sw_vol_mat, rc_list = multichannel_vol_stripwell(collection)
            show do
                title "Aliquot Stop Ligation Buffer (STL) for Multichannel"
                separator
                note "Follow the table to aliquot the Stop Ligation Buffer (STL) into a stripwell for the next step:"
                table highlight_alpha_rc(sw, rc_list){|r,c| "#{sw_vol_mat[r][c]*5}#{MICROLITERS}"}
            end
            sw.mark_as_deleted
            sw.save
        end
        show do
            title "Adding Stop Ligation Buffer (STL) to #{collection.id}"
            separator
            note "Follow the table below to aliquot the <b>STL</b> to the appropriate wells of <b>#{collection}</b>:"
            bullet "Mix by pipetting up and down 7 times."
            table highlight_alpha_non_empty(collection){|r,c| "#{5}#{MICROLITERS}"}
            check "Finally, seal and centrifuge at 280 x g for 1 min"
        end
    end
    
    def clean_up_indexed_cDNA(collection, sample_type)
        (sample_type != 'DNA Library') ? clean_up_bead_type = 'AMPure XP Beads' : clean_up_bead_type = 'Sample Purification Beads (SPB)'
        (sample_type != 'DNA Library') ? library_type = 'DNA' : library_type = 'cDNA'
        if collection.get_non_empty.length > 19
            sw, sw_vol_mat, rc_list = multichannel_vol_stripwell(collection)
            show do
                title "Aliquot #{clean_up_bead_type} for Multichannel"
                separator
                check "Vortex the #{clean_up_bead_type} for at least 1 minute or until they are well dispersed."
                note "Follow the table to aliquot the #{clean_up_bead_type} into a stripwell for the next step:"
                bullet "The maximum volume in a stripwell well is 300#{MICROLITERS}"
                table highlight_alpha_rc(sw, rc_list){|r,c| "#{sw_vol_mat[r][c]*42}#{MICROLITERS}"}
            end
            sw.mark_as_deleted
            sw.save
        end
        show do
            title "Adding #{clean_up_bead_type} to <b>#{collection}</b>"
            separator
            note "Follow the table below to aliquot the <b>#{clean_up_bead_type}</b> to the appropriate wells of <b>#{collection}</b>:"
            bullet "Mix by pipetting up and down 7 times."
            table highlight_alpha_non_empty(collection){|r,c| "#{42}#{MICROLITERS}"}
            check "Finally, seal & incubate for 5 min at room temperature (on Bench)"
        end
        show do
            title "Cleaning Up Indexed #{library_type} Libraries"
            separator
            check "Gather a new clean multichannel resivior"
            check "Pour freshly prepared 80% EtOH"
            note "Continue to the next step."
        end
        show do
            title "Cleaning Up Indexed #{library_type} Libraries"
            separator
            check "After incubation, place plate on the magentic stand at room temperature for 5 mins"
            warning "WITHOUT DISTURBING BEADS"
            check "Remove and discard 79.5#{MICROLITERS} of supernatant from each well of <b>#{collection}</b>"
        end
        washes = 1
        (2).times do
            show do 
                title "Washing Indexed #{library_type} Libraries (#{washes}/2)"
                separator
                note "With the plate <b>#{collection}</b> on the magnetic stand, add <b>200#{MICROLITERS}</b> of 80% EtOH"
                warning "DO NOT DISTURB THE BEADS!"
                table highlight_alpha_non_empty(collection){|r,c| "#{200}#{MICROLITERS}"}
                check "Incubate for 30 secs"
            end
            show do 
                title "Washing Indexed #{library_type} Libraries"
                separator
                warning "DO NOT DISTURB THE BEADS!"
                check "Remove and discard all of the supernatant from each well"
            end
            if washes == 2
                show do 
                    title "Drying Indexed #{library_type} Libraries"
                    separator
                    check "Seal plate with a Aera Breathable seal"
                    check "Let samples air-dry at room temperature for 10 mins"
                    bullet "Place plate on plate rotator to expidite process and ensure drying"
                end
            end
            washes += 1
        end
        if collection.get_non_empty.length > 19
            sw, sw_vol_mat, rc_list = multichannel_vol_stripwell(collection)
            show do
                title "Aliquot Resuspension Buffer (RSB) for Multichannel"
                separator
                note "Follow the table to aliquot the Resuspension Buffer (RSB) into a stripwell for the next step:"
                bullet "The maximum volume in a stripwell well is 300#{MICROLITERS}"
                table highlight_alpha_rc(sw, rc_list){|r,c| "#{sw_vol_mat[r][c]*52.5}#{MICROLITERS}"}
            end
            sw.mark_as_deleted
            sw.save
        end
        
        show do
            title "Eluting Indexed #{library_type} Libaries"
            separator
            check "Remove plate #{collection.id} from magnetic plate."
            note "Follow the table to aliquot Resuspension Buffer to the appropriate wells:"
            bullet "Mix throughly by pipetting until the beads are dispersed!"
            table highlight_alpha_non_empty(collection){|r,c| "#{52.5}#{MICROLITERS}"}
            check "Seal plate & incubate at room temperature for 2 mins"
            check "Next, place plate on magnetic stand and incubate for 5 mins"
            note "Continue to next step while incubating."
        end
        show do 
            title "Prepare for Second Clean Up"
            separator
            check "Gather a new, clean <b>96 Well PCR Plate</b> or <b>96 Well MIDI 0.8mL Plate</b> and label: <b>Second_#{collection}</b>"
            check "Gather and vortex <b>#{clean_up_bead_type}</b>"
            note "Follow the table below to fill the appropriate wells of <b>Second_#{collection}</b> with #{clean_up_bead_type}:"
            table highlight_alpha_non_empty(collection){|r,c| "#{50}#{MICROLITERS}"}
        end
        show do
            title "Eluting Indexed #{library_type} Libaries"
            separator
            note "With the plate on the magnetic stand"
            warning "DO NOT DISTUB BEADS"
            check "Transfer <b>50#{MICROLITERS}</b> of supernatant in plate <b>#{collection}</b> to the coresponding well in <b>Second_#{collection}</b>."
            bullet "Mix throughly by pipetting 7 times."
            check "Incuabate for 15 mins."
        end
        
        # Second ethanol clean up
        show do
            title "Second Clean Up of Indexed #{library_type} Libraries"
            separator
            check "After incubation, place <b>Second_#{collection}</b> on the magentic stand at room temperature for 5 mins"
            warning "WITHOUT DISTURBING BEADS"
            check "Remove and discard 95#{MICROLITERS} of supernatant from each well of <b>Second_#{collection}</b>"
        end
        washes = 1
        (2).times do
            show do 
                title "Washing Indexed #{library_type} Libraries (#{washes}/2)"
                separator
                note "With the plate <b>Second_#{collection}</b> on the magnetic stand, add <b>200#{MICROLITERS}</b> of 80% EtOH"
                warning "DO NOT DISTURB THE BEADS!"
                table highlight_alpha_non_empty(collection){|r,c| "#{200}#{MICROLITERS}"}
                check "Incubate for 30 secs"
            end
            show do 
                title "Washing Indexed #{library_type} Libraries (#{washes}/2)"
                separator
                warning "DO NOT DISTURB THE BEADS!"
                check "Remove and discard all of the supernatant from each well"
            end
            washes += 1
            if washes == 2
                show do 
                    title "Drying Indexed #{library_type} Libraries"
                    separator
                    check "Seal plate with a Aera Breathable seal"
                    check "Let samples air-dry at room temperature for 15 mins"
                    bullet "Place plate on plate rotator to expidite process and ensure drying"
                end
            end
        end
    end
    
    def final_elution(in_collection, out_collection)
        sample_type = in_collection.matrix.flatten.select {|s_id| s_id != -1}.map {|s_id| Sample.find(s_id).sample_type.name }.uniq
        library_type = (sample_type == "Yeast Strain") ? "cDNA" : "DNA"
        
        if in_collection.get_non_empty.length > 19
            sw, sw_vol_mat, rc_list = multichannel_vol_stripwell(in_collection)
            show do
                title "Aliquot Resuspension Buffer (RSB) for Multichannel"
                separator
                note "Follow the table to aliquot the Resuspension Buffer (RSB) into a stripwell for the next step:"
                bullet "The maximum volume in a stripwell well is 300#{MICROLITERS}"
                table highlight_alpha_rc(sw, rc_list){|r,c| "#{sw_vol_mat[r][c]*27.5}#{MICROLITERS}"}
            end
            sw.mark_as_deleted
            sw.save
        end
        show do
            title "Eluting Indexed #{library_type} Libaries"
            separator
            check "Ensure that beads are dry, then remove <b>Second_#{in_collection}</b> from magnetic stand."
            note "Follow the table to aliquot Resuspension Buffer to the appropriate wells:"
            bullet "Mix throughly by pipetting until the beads are dispersed!"
            table highlight_alpha_non_empty(in_collection){|r,c| "#{27.5}#{MICROLITERS}"}
            check "Seal plate & incubate at room temperature for 2 mins"
            check "Next, centrifuge plate at 280 x g for 1 min"
            check "Next, place plate on magnetic stand and incubate for 5 mins"
            note "Continue to next step while incubating."
        end
        show do
            title "Eluting Indexed #{library_type} Libaries"
            separator
            check "Gather a new, clean #{out_collection.object_type.name} and label: <b>#{out_collection}</b>"
            warning "KEEP PLATE ON MAGNETIC STAND & DO NOT DISTURB BEADS"
            check "Once incubation period is finished, transfer <b>25#{MICROLITERS}</b> from each well of <b>Second_#{in_collection}</b> to the new <b>#{out_collection}</b> plate."
            check "Finally, seal plate."
        end
        in_collection.mark_as_deleted
        in_collection.save
        out_collection.location = "-20°C Freezer NGSeq Section"
        out_collection.save
    end
end # Module Ligate_Adapters
